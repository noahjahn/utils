source "$NOAHJAHN_UTILS_DIR/scripts/bash/base-image-tag.sh"
source "$NOAHJAHN_UTILS_DIR/scripts/bash/validate-binary.sh"

git=$(_validate_binary git)
printf=$(_validate_binary printf)
docker=$(_validate_binary docker)
id=$(_validate_binary uuidgen)

print_usage() {
    $printf "Usage:\tutils [OPTIONS] [COMMANDS]\n"
    $printf "\nCLI helper for running and using utils\n\n"
    $printf "Commands:\n"
    $printf "  help \t\tDisplay usage and how to use the script\n"
    $printf "  update \tUpdate the utils\n"
    $printf "  verify \tVerify you have all the dependencies needed to use these utils\n"
}

update() {
    cd "$NOAHJAHN_UTILS_DIR"
    $git pull
    $git submodule update --init --recursive --remote

    IMAGE_TAG="$BASE_IMAGE_TAG-golang"
    CONTAINER_NAME="$IMAGE_TAG-$($id +%s)"

    $docker run --name $CONTAINER_NAME --rm --entrypoint=tail -d $IMAGE_TAG -f /dev/null

    mkdir -p /tmp/go
    $docker cp $CONTAINER_NAME:/usr/local/go /tmp
    $docker stop -t 1 $CONTAINER_NAME
    sudo mv /tmp/go /usr/local/go
}

verify() {
    _validate_binary cd
    _validate_binary date
    _validate_binary printf
    _validate_binary mkdir
    _validate_binary getopts
    _validate_binary sed
    _validate_binary uuidgen
    _validate_binary git
    _validate_binary docker
}

while true; do
    case "$1" in
    update)
        update
        break
        ;;
    verify)
        verify
        break
        ;;
    help)
        print_usage
        exit 0
        ;;
    --)
        shift
        break
        ;;
    *)
        print_usage
        break
        ;;
    esac
done

exit 0
